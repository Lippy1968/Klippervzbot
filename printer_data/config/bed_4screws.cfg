[gcode_macro TRAM]
description: "Measure 4 bed screws and show turn instructions"
gcode:
    G90
    G1 Z10 F3000

    ; Define 4 screw positions at bed corners
    {% set screws = [
        {'name': 'Front Left',  'x': 15,  'y': 4},
        {'name': 'Front Right', 'x': 320, 'y': 4},
        {'name': 'Rear Right',  'x': 320, 'y': 262},
        {'name': 'Rear Left',   'x': 15,  'y': 262}
    ] %}

    {% set z_heights = [] %}

    ; Probe each screw
    {% for screw in screws %}
        M117 Probing { screw.name }
        G1 X{ screw.x } Y{ screw.y } F6000
        G1 Z10 F300
        PROBE
        {% set z = printer["toolhead"].position.z %}
        RESPOND PREFIX="info" MSG="'{ screw.name }' Z = '{ '%.3f' % z }'"
        {% set z_heights=z_heights.append(z) %}
    {% endfor %}

    {% set reference_z = z_heights[0] %}
    RESPOND PREFIX="info" MSG="Reference ({ screws[0].name }) Z = { '%.3f' % reference_z }"

    ; Constants
    {% set pitch_per_rev = 0.5 %}
    {% set mm_per_deg = pitch_per_rev / 360.0 %}
    {% set click_degrees = 30 %}  ; Adjust for your detent step size

    ; Show turn instructions for other screws
    {% for i in range(1, screws|length) %}
        {% set delta = z_heights[i] - reference_z %}
        {% set degrees = delta / mm_per_deg %}
        {% set full_turns = degrees / 360 %}
        {% set quarter_turns = degrees / 90 %}
        {% set clicks = degrees / click_degrees %}
        
        RESPOND PREFIX="info" MSG="{ screws[i].name } offset = { '%+.3f' % delta } mm"
        RESPOND PREFIX="info" MSG="-> { '%+.0f' % degrees }Â° | { '%+.2f' % full_turns } full turns | { '%+.2f' % quarter_turns } quarter turns | { '%+.1f' % clicks } clicks"
    {% endfor %}

    M117 4-point leveling measured
