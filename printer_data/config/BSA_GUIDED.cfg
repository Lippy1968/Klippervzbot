[gcode_macro BSA_GUIDED]
description: "Guided bed screw leveling with repeated probing per screw"
gcode:
    {% set screw_points = [(70, 70), (270, 70), (270, 270), (70, 270)] %}
    {% set screw_names = ['FL', 'FR', 'BR', 'BL'] %}
    {% set pitch = 0.5 %}
    {% set tolerance = 0.02 %}
    G90
    G1 Z10 F600

    # Probe reference screw
    {% set ref_x = screw_points[0][0] %}
    {% set ref_y = screw_points[0][1] %}
    {% set ref_name = screw_names[0] %}
    M117 Probing reference screw
    G1 X{ref_x} Y{ref_y} F3000
    PROBE
    {% set ref = printer.beacon.last_z_result|float %}
    {% set ref_rounded = ref|round(3) %}
    RESPOND PREFIX="Bed Leveling" MSG="Reference Z = {ref_rounded} mm"

    # Loop through remaining screws
    {% for i in range(1, screw_points|length) %}
        {% set name = screw_names[i] %}
        {% set x = screw_points[i][0] %}
        {% set y = screw_points[i][1] %}
        {% set success = 0 %}

        {% for attempt in range(1, 6) %}
            {% if success == 0 %}
                M117 Probing screw {name} - Attempt {attempt}
                G1 X{x} Y{y} F3000
                PROBE
                {% set z = printer.beacon.last_z_result|float %}
                {% set delta = z - ref %}
                {% set turns = delta / pitch %}
                {% set degrees = turns * 360 %}
                {% set delta_rounded = delta|round(3) %}
                {% set degrees_rounded = degrees|round(1) %}
                RESPOND PREFIX="Adjust {name}" MSG="Offset = %0.3f mm → Turn screw %0.1f°" % (delta_rounded, degrees_rounded)
                RESPOND PREFIX="Adjust {name}" MSG="Adjust screw, then press CONTINUE..."
                PAUSE

                {% if delta|abs < tolerance %}
                    RESPOND PREFIX="Bed Leveling" MSG="{name} within tolerance (%0.3f mm)" % delta_rounded
                    {% set success = 1 %}
                {% endif %}
            {% endif %}
        {% endfor %}

        {% if success == 0 %}
            RESPOND PREFIX="Bed Leveling" MSG="WARNING: {name} still off by %0.3f mm after 5 tries" % delta_rounded
        {% endif %}
    {% endfor %}

    M117 Bed leveling complete
    RESPOND PREFIX="Bed Leveling" MSG="All screws adjusted. Process complete."