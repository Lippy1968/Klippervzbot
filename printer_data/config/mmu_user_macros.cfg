# mmu_user_macros.cfg
# Custom MMU helper macros: tuned cut + post-load purge

[gcode_macro MMU_TUNED_CUT_TIP]
description: Tuned Magneto cut for Goliath + Orbiter 2 using _MMU_CUT_TIP_VARS
gcode:
    {% set cut = printer['gcode_macro _MMU_CUT_TIP_VARS'] %}

    {% set retract    = cut.retract_length|float %}
    {% set rip        = cut.rip_length|float %}
    {% set rip_speed  = cut.rip_speed|float %}
    {% set push       = cut.pushback_length|float %}
    {% set push_dwell = cut.pushback_dwell_time|float %}
    {% set slow       = cut.cut_slow_move_speed|float %}
    {% set fast       = cut.cut_fast_move_speed|float %}
    {% set dwell      = cut.cut_dwell_time|float %}
    {% set ex_speed   = cut.extruder_move_speed|float %}
    {% set travel     = cut.travel_speed|float %}
    {% set pin_x      = cut.pin_loc_xy[0]|float %}
    {% set pin_y      = cut.pin_loc_xy[1]|float %}
    {% set pin_cx     = cut.pin_loc_compressed_xy[0]|float %}
    {% set pin_cy     = cut.pin_loc_compressed_xy[1]|float %}

    { action_respond_info("MMU_TUNED_CUT_TIP: Cutting (retract=%.1fmm, rip=%.2fmm, dwell=%dms)" % (retract, rip, dwell)) }

    SAVE_GCODE_STATE NAME=MMU_TUNED_CUT_STATE

    G90
    M83

    # 1) Retract to move soft zone above cutter
    G1 E-{retract} F{ex_speed * 60}

    # 2) Move to relaxed pin
    G1 X{pin_x} Y{pin_y} F{travel * 60}

    # 3) Press into cutter
    G1 X{pin_cx} Y{pin_cy} F{slow * 60}
    G4 P{dwell}

    # 4) Rip while on blade
    {% if rip > 0 %}
      G1 E-{rip} F{rip_speed * 60}
    {% endif %}

    # 5) Optional pushback
    {% if push > 0 %}
      G1 E{push} F{ex_speed * 60}
      {% if push_dwell > 0 %}
        G4 P{push_dwell}
      {% endif %}
    {% endif %}

    # 6) Release off the cutter
    G1 X{pin_x} Y{pin_y} F{fast * 60}

    RESTORE_GCODE_STATE NAME=MMU_TUNED_CUT_STATE MOVE=0



[gcode_macro HH_PURGE_AFTER_LOAD]
description: Small purge into bucket then WIPE after HH filament load
gcode:
    {% set state = printer.print_stats.state %}
    {% if state == "printing" or state == "paused" %}
        M118 HH: Purging into bucket after MMU load...

        M83
        G90

        # 1) Go to purge bucket
        G1 X339 Y42 F18000
        G1 Z5 F600

        # 2) Small purge (tune 6â€“12mm as needed)
        G1 Z0.4 F600
        G1 E14 F600
        G1 E-1.0 F600
        G4 P200

        # 3) Use your existing WIPE macro for brush wiping
        WIPE

        M118 HH: Post-load bucket purge + wipe complete.
    {% else %}
        M118 HH: Skipping HH_PURGE_AFTER_LOAD (not printing).
    {% endif %}
